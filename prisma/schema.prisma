generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Media table for storing images/videos as Base64
model Media {
  id        String   @id @default(cuid())
  name      String   // Original filename
  mimeType  String   // e.g., "image/png", "video/mp4"
  data      String   @db.Text // Base64 encoded data
  size      Int      // Size in bytes
  createdAt DateTime @default(now())
}

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String?   @unique
  password      String?
  role          String    @default("customer")
  orders        Order[]
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
}

model Product {
  id              String      @id @default(cuid())
  category        String
  type            String
  name            String
  gender          String
  new             Boolean     @default(false)
  sale            Boolean     @default(false)
  bestSeller      Boolean     @default(false)
  rate            Int         @default(0)

  price           Float
  originPrice     Float
  brand           String      @default("Anose")
  sold            Int         @default(0)
  quantity        Int         @default(0)
  quantityPurchase Int        @default(1)
  sizes           String?
  description     String
  ingredients     String?     // Product ingredients, comma-separated
  slug            String      @unique
  images          String
  thumbImage      String
  videoUrl        String?     // Optional video URL - if set, shows video instead of image
  priority        Int         @default(0)
  variations      Variation[]
  items           OrderItem[]
  reviews         ProductReview[]
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
}

model Variation {
  id         String  @id @default(cuid())
  productId  String
  product    Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  color      String
  colorCode  String
  colorImage String
  image      String
}

model Order {
  id            String      @id @default(cuid())
  orderNumber   Int         @unique @default(autoincrement())
  userId        String?
  user          User?       @relation(fields: [userId], references: [id])
  customerName  String?
  customerEmail String?
  customerPhone String?
  items         OrderItem[]
  total         Float
  status        String      @default("PENDING")
  paymentStatus String    @default("PENDING")
  paymentMethod String    @default("ONLINE")
  shippingFee   Float       @default(0)
  discountAmount Float      @default(0)
  promoCode     String?
  address       String?
  cancelRequest String?   // PENDING, APPROVED, REJECTED
  returnRequest String?   // PENDING, APPROVED, REJECTED
  cancelReason  String?
  returnReason  String?
  // Shipping Fields (Generic)
  shippingProvider String?   @default("RAPIDSHYP")
  awbNumber       String?   // Tracking ID
  shippingStatus  String?   // Shipping status from provider
  weight          Float?    @default(0.5) // KG
  shippedAt       DateTime? 
  deliveredAt     DateTime? 
  estimatedDelivery DateTime? 
  trackingUrl     String?   
  lastTrackingSync DateTime? 
  whatsappAlertSent Boolean  @default(false) 
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
}

model OrderItem {
  id        String  @id @default(cuid())
  orderId   String
  order     Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  productId String
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  quantity  Int
  price     Float
}

model PromoCode {
  id            String    @id @default(cuid())
  code          String    @unique
  discountType  String    @default("PERCENTAGE") // PERCENTAGE, FIXED
  discountValue Float
  minOrderValue Float?    @default(0)
  maxDiscount   Float?
  usageLimit    Int?
  usedCount     Int       @default(0)
  expiresAt     DateTime?
  isActive      Boolean   @default(true)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
}

model ContactInquiry {
  id        String   @id @default(cuid())
  name      String
  email     String
  phone     String?
  message   String
  status    String   @default("UNREAD") // UNREAD, READ, ARCHIVED
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// Zoho Invoice cache
model Invoice {
  id            String   @id @default(cuid())
  zohoInvoiceId String   @unique
  orderId       String?
  customerId    String
  customerName  String
  invoiceNumber String
  status        String   // DRAFT, SENT, PAID, OVERDUE, VOID
  total         Float
  balance       Float    @default(0)
  dueDate       DateTime?
  invoiceDate   DateTime
  pdfUrl        String?
  syncedAt      DateTime @default(now())
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

// Sales Funnel Models
model FunnelStage {
  id        String   @id @default(cuid())
  name      String   // NEW, CONTACTED, QUALIFIED, PROPOSAL, WON, LOST
  order     Int
  color     String
  leads     Lead[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Lead {
  id          String         @id @default(cuid())
  name        String
  email       String
  phone       String?
  company     String?
  source      String         // WEBSITE, WHATSAPP, IMPORT, MANUAL
  stageId     String
  stage       FunnelStage    @relation(fields: [stageId], references: [id])
  value       Float?
  notes       String?
  activities  LeadActivity[]
  followUps   LeadFollowUp[]
  convertedAt DateTime?
  orderId     String?
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
}

model LeadFollowUp {
  id          String    @id @default(cuid())
  leadId      String
  lead        Lead      @relation(fields: [leadId], references: [id], onDelete: Cascade)
  scheduledAt DateTime  // When to follow up
  notes       String?   // Notes about what to discuss
  status      String    @default("PENDING") // PENDING, COMPLETED, CANCELLED
  completedAt DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([leadId])
  @@index([scheduledAt])
  @@index([status])
}

model LeadActivity {
  id        String   @id @default(cuid())
  leadId    String
  lead      Lead     @relation(fields: [leadId], references: [id], onDelete: Cascade)
  type      String   // NOTE, CALL, EMAIL, WHATSAPP, STAGE_CHANGE
  content   String
  createdAt DateTime @default(now())
}

// WhatsApp Marketing Models
model WhatsAppTemplate {
  id        String   @id @default(cuid())
  name      String
  content   String
  variables String   // JSON array of variable names like ["name", "order_id"]
  approved  Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model WhatsAppCampaign {
  id             String            @id @default(cuid())
  name           String
  templateId     String
  status         String            // DRAFT, SCHEDULED, RUNNING, COMPLETED
  audience       String            // ALL, SEGMENT, LEADS
  sentCount      Int               @default(0)
  deliveredCount Int               @default(0)
  scheduledAt    DateTime?
  messages       WhatsAppMessage[]
  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt
}

model WhatsAppMessage {
  id         String            @id @default(cuid())
  campaignId String?
  campaign   WhatsAppCampaign? @relation(fields: [campaignId], references: [id])
  phone      String
  content    String
  status     String            // SENT, DELIVERED, READ, FAILED
  sentAt     DateTime          @default(now())
}

// Expense Management (synced with Zoho Invoice)
model Expense {
  id              String    @id @default(cuid())
  zohoExpenseId   String?   @unique  // null for local-only expenses
  date            DateTime
  category        String              // TRAVEL, OFFICE_SUPPLIES, MARKETING, UTILITIES, RENT, SALARY, MISC
  amount          Float
  vendor          String?
  description     String?
  reference       String?             // receipt number, invoice number, etc.
  paymentMode     String?             // CASH, CARD, BANK_TRANSFER, UPI
  isBillable      Boolean   @default(false)
  status          String    @default("RECORDED") // RECORDED, SYNCED
  syncedAt        DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
}

// Quotations/Estimates (synced with Zoho Invoice)
model Quotation {
  id               String    @id @default(cuid())
  zohoEstimateId   String?   @unique
  quotationNumber  String
  customerId       String?
  customerName     String
  customerEmail    String?
  status           String    @default("DRAFT") // DRAFT, SENT, ACCEPTED, DECLINED, EXPIRED, INVOICED
  total            Float
  subtotal         Float     @default(0)
  discount         Float     @default(0)
  tax              Float     @default(0)
  expiryDate       DateTime?
  quotationDate    DateTime
  notes            String?
  terms            String?
  lineItems        Json?     // Store line items as JSON array
  syncedAt         DateTime?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
}

// Page View tracking for analytics
model PageView {
  id        String   @id @default(cuid())
  path      String   // e.g., "/", "/shop", "/product/xyz"
  sessionId String   // Anonymous session ID
  userAgent String?
  referrer  String?
  createdAt DateTime @default(now())

  @@index([createdAt])
  @@index([sessionId])
}

// Newsletter Subscribers
model NewsletterSubscriber {
  id           String   @id @default(cuid())
  email        String   @unique
  isActive     Boolean  @default(true)
  subscribedAt DateTime @default(now())
  unsubscribedAt DateTime?
}

// Product Reviews
model ProductReview {
  id            String   @id @default(cuid())
  productId     String
  product       Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  customerName  String
  customerEmail String?
  rating        Int      // 1-5
  title         String?
  comment       String
  isVerified    Boolean  @default(false) // Verified purchase
  isApproved    Boolean  @default(false) // Admin approval
  createdAt     DateTime @default(now())

  @@index([productId])
  @@index([isApproved])
}

model AbandonedCheckout {
  id            String   @id @default(cuid())
  userId        String?
  customerName  String?
  customerEmail String?
  customerPhone String?
  shippingInfo  String?  @db.Text // Store as JSON string
  cartItems     String?  @db.Text // Store as JSON string
  total         Float?
  status        String   @default("ABANDONED") // ABANDONED, RECOVERED
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

